# -*- coding: utf-8 -*-
"""project3_7.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ejH6md_Yug02CybmzF9bM9-3x9Absp67
"""

"""
Author: Jungmyung Lee

This script loads the BAR_M Z-axis trajectory and five EMG channels,
then visualizes them in two synchronized sets of subplots: the full time
series and a manually selected time window.

Each EMG signal is preprocessed using:
    notch filtering â†’ bandpass filtering â†’ rectification â†’ envelope extraction.

The output consists of 6 full-length plots + 6 sliced-window plots
(12 total), allowing direct comparison between barbell motion and
muscle activation patterns.
"""


import scipy.io as sio
import numpy as np
import matplotlib.pyplot as plt
from scipy.signal import butter, filtfilt, iirnotch


# =========================
# Load squat.mat
# =========================
mat = sio.loadmat("/content/squat.mat")
root = mat['qtm_50_c2']

analog = root[0,0]['Analog']
traj   = root[0,0]['Trajectories'][0,0]['Labeled'][0,0]

# ì‚¬ìš©í•  EMG indexë“¤
emg_indices = [3, 4, 5, 6, 8]

# =========================
# Trajectory (BAR_M Z) ì¤€ë¹„
# =========================
labels     = traj['Labels'][0]          # (1, N) object array
data       = traj['Data']              # (N, 4, frames)
frame_rate = float(root[0,0]['FrameRate'][0,0])
frames     = int(root[0,0]['Frames'][0,0])

# BAR_M ì¸ë±ìŠ¤ ì°¾ê¸°
label_list = [str(l[0]) for l in labels]
bar_idx    = label_list.index("BAR_M")

# Z-axis (index 2)ë§Œ ì‚¬ìš©
bar_z = data[bar_idx, 2, :]                     # (frames,)
t_bar = np.arange(frames) / frame_rate          # ëª¨ì…˜ìº¡ì³ ì‹œê°„ì¶•


# =========================
# í•„í„° í•¨ìˆ˜ë“¤
# =========================
# Lowpass filter function (4â€“8 Hz)
def lowpass(cut, fs, order=4):
    nyq = fs / 2
    b, a = butter(order, cut/nyq, btype='low')
    return b, a

# Bandpass filter function
def bandpass(low, high, fs, order=4):
    nyq = fs / 2
    b, a = butter(order, [low/nyq, high/nyq], btype='band')
    return b, a


# =========================
# PLOT (ë§¨ ìœ„: BAR_Z, ê·¸ ì•„ë˜ EMGë“¤)
# =========================
n_rows = len(emg_indices) + 1      # 1ê°œëŠ” BAR_Z, ë‚˜ë¨¸ì§€ëŠ” EMG
plt.figure(figsize=(15, 16))

# ---------- Row 1: BAR_Z ----------
ax0 = plt.subplot(n_rows, 1, 1)
ax0.plot(t_bar, bar_z, linewidth=1.5)
ax0.set_ylabel("BAR Z", fontsize=12)
ax0.set_title("BAR Z + EMG Rectified + Envelope", fontsize=16)
ax0.grid(True, alpha=0.3)

# ğŸ”¥ HERE: BAR_Zì—ë„ 0.1ì´ˆ ë§ˆì´ë„ˆ ëˆˆê¸ˆ ì¶”ê°€
ax0.set_xticks(np.arange(t_bar[0], t_bar[-1], 0.1), minor=True)
ax0.grid(True, which='minor', alpha=0.2)



# ---------- ì•„ë˜ Rowë“¤: EMG ----------
for i, idx in enumerate(emg_indices):

    emg = analog[0, idx]
    raw = emg['Data'][0]
    fs  = float(emg['Frequency'][0,0])

    # ------------ PREPROCESSING -------------
    # 1. Baseline removal
    x = raw - np.mean(raw)

    # 2. 100Hz Notch filter
    b_notch, a_notch = iirnotch(100/(fs/2), 30)
    x = filtfilt(b_notch, a_notch, x)

    # 3. Bandpass 20â€“450 Hz
    b_bp, a_bp = bandpass(20, 450, fs)
    x_bp = filtfilt(b_bp, a_bp, x)

    # 4. Rectification
    rect = np.abs(x_bp)

    # 5. Envelope using Low-pass Filter (LPF 4â€“8Hz)
    b_lp, a_lp = lowpass(6, fs)   # 6 Hz ì¤‘ì‹¬
    env = filtfilt(b_lp, a_lp, rect)

    # EMG time vector
    t_emg = np.arange(len(raw)) / fs

    # ------------ PLOT -------------
    ax = plt.subplot(n_rows, 1, i+2)   # +2: 1í–‰ì€ BAR_Z

    # rectified (blue)
    ax.plot(t_emg, rect, linewidth=0.5, label="Rectified")

    # envelope (orange)
    ax.plot(t_emg, env, linewidth=1.2, label="Envelope")

    # Styling
    ax.set_ylabel(f"EMG {idx}", fontsize=12)
    ax.grid(True, alpha=0.3)

    # ğŸ”¥ ì—¬ê¸° ì¶”ê°€ (0.1 sec ë§ˆì´ë„ˆ ëˆˆê¸ˆ)
    ax.set_xticks(np.arange(t_emg[0], t_emg[-1], 0.1), minor=True)
    ax.grid(True, which='minor', alpha=0.2)

    # xì¶• ë²”ìœ„ë¥¼ BAR_Zì™€ ë§ì¶°ì£¼ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì¤„ í™œì„±í™”
    ax.set_xlim(t_bar[0], t_bar[-1])

    # TitleëŠ” ë§¨ ìœ„ì—ì„œë§Œ
    if i == 0:
        pass

    # ë§ˆì§€ë§‰ subplotì—ì„œë§Œ xì¶• ë¼ë²¨ í‘œì‹œ
    if i == len(emg_indices) - 1:
        ax.set_xlabel("Time (s)", fontsize=12)
    # else:
    #     ax.tick_params(labelbottom=False)
print(label_list)

plt.tight_layout()
plt.show()

# =========================
# EXTRA SUBPLOTS â€” SLICED 11.5 ~ 15.7 sec
# =========================

#scope

slice_start = 11.5
slice_end   = 15.7

# ìƒˆë¡œìš´ figure í˜¹ì€ ê¸°ì¡´ figure ì•„ë˜ì— ì¶”ê°€ ê°€ëŠ¥
plt.figure(figsize=(15, 16))

# ---------- Slice Row 1: BAR_Z ----------
mask_bar = (t_bar >= slice_start) & (t_bar <= slice_end)
bar_z_slice = bar_z[mask_bar]
t_bar_slice = t_bar[mask_bar]

ax0 = plt.subplot(n_rows, 1, 1)
ax0.plot(t_bar_slice, bar_z_slice, linewidth=1.5)
ax0.set_ylabel("BAR Z (slice)", fontsize=12)
ax0.set_title(f"Sliced BAR Z + EMG  ({slice_start} ~ {slice_end} sec)", fontsize=16)
ax0.grid(True, alpha=0.3)
ax0.set_xticks(np.arange(slice_start, slice_end, 0.1), minor=True)
ax0.grid(True, which='minor', alpha=0.2)


# ---------- Slice EMG Rows ----------
for i, idx in enumerate(emg_indices):

    # ë‹¤ì‹œ EMG raw ë¶ˆëŸ¬ì˜¤ê¸°
    emg = analog[0, idx]
    raw = emg['Data'][0]
    fs  = float(emg['Frequency'][0,0])

    # PREPROCESS
    x = raw - np.mean(raw)
    b_notch, a_notch = iirnotch(100/(fs/2), 30)
    x = filtfilt(b_notch, a_notch, x)
    b_bp, a_bp = bandpass(20, 450, fs)
    x_bp = filtfilt(b_bp, a_bp, x)
    rect = np.abs(x_bp)
    b_lp, a_lp = lowpass(6, fs)
    env = filtfilt(b_lp, a_lp, rect)


    # EMG time axis
    t_emg = np.arange(len(raw)) / fs

    # Slice
    mask_emg = (t_emg >= slice_start) & (t_emg <= slice_end)
    t_emg_slice = t_emg[mask_emg]
    rect_slice  = rect[mask_emg]
    env_slice   = env[mask_emg]

    ax = plt.subplot(n_rows, 1, i+2)

    ax.plot(t_emg_slice, rect_slice, linewidth=0.5)
    ax.plot(t_emg_slice, env_slice, linewidth=1.2)
    ax.set_ylabel(f"EMG {idx} (slice)", fontsize=12)
    ax.grid(True, alpha=0.3)

    ax.set_xticks(np.arange(slice_start, slice_end, 0.1), minor=True)
    ax.grid(True, which='minor', alpha=0.2)

    if i == len(emg_indices) - 1:
        ax.set_xlabel("Time (s)", fontsize=12)

plt.tight_layout()
plt.show()
